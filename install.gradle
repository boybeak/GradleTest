import java.util.zip.ZipFile

// å®šä¹‰ ANSI é¢œè‰²ä»£ç 
class Colors {
    static final String RESET = "\u001B[0m"
    static final String RED = "\u001B[31m"
    static final String GREEN = "\u001B[32m"
    static final String YELLOW = "\u001B[33m"
    static final String BLUE = "\u001B[34m"
}

// å°†æ—¥å¿—æ–¹æ³•æ·»åŠ åˆ° extra å±æ€§ä¸­ï¼Œä»¥ä¾¿åœ¨æ•´ä¸ªè„šæœ¬ä¸­è°ƒç”¨
ext {
    logInfo = { message ->
        println "${Colors.BLUE}[INFO] $message${Colors.RESET}"
    }
    logSuccess = { message ->
        println "${Colors.GREEN}[SUCCESS] $message${Colors.RESET}"
    }
    logWarning = { message ->
        println "${Colors.YELLOW}[WARNING] $message${Colors.RESET}"
    }
    logError = { message ->
        println "${Colors.RED}[ERROR] $message${Colors.RESET}"
    }

    repositoryRoot = {
        File current = project.projectDir
        while (current.exists() && !new File(current, ".git").exists()) {
            current = current.parentFile
        }
        if (!current.exists()) {
            throw new IllegalStateException("No .git found in this project")
        }
        return current
    }
    gitRoot = new File(repositoryRoot(), ".git")
    gitHooksDir = new File(gitRoot, "hooks")
    preCommitFile = new File(gitHooksDir, "pre-commit")
    resCheckerFile = new File(gitRoot, "cli/res-checker.jar")

    toolsZipUrl = "https://github.com/boybeak/GradleTest/raw/refs/heads/main/tools.zip"
}

def download = { url, dstFile ->
    // ç¡®ä¿ç›®æ ‡æ–‡ä»¶æ˜¯ File å¯¹è±¡
    File dest = dstFile instanceof File ? dstFile : new File(dstFile.toString())

    // åˆ›å»ºç›®æ ‡ç›®å½•
    dest.parentFile.mkdirs()

    logInfo "å¼€å§‹ä¸‹è½½: $url"
    logInfo "ä¿å­˜è·¯å¾„: ${dest.absolutePath}"

    try {
        // åˆ›å»ºè¿æ¥ï¼ˆæ”¯æŒHTTP/HTTPSï¼‰
        def connection = new URL(url).openConnection()
        connection.connectTimeout = 15000 // 15ç§’è¿æ¥è¶…æ—¶
        connection.readTimeout = 30000    // 30ç§’è¯»å–è¶…æ—¶

        // éªŒè¯å“åº”ï¼ˆæ£€æŸ¥HTTP 200ï¼‰
        def responseCode = connection.responseCode
        if (responseCode != 200) {
            throw new IOException("HTTPé”™è¯¯: $responseCode - ${connection.responseMessage}")
        }

        // æµå¼å†™å…¥æ–‡ä»¶
        dest.withOutputStream { out ->
            out << connection.inputStream
        }

        logSuccess "âœ…ä¸‹è½½æˆåŠŸ"
    } catch (Exception e) {
        logError "âä¸‹è½½å¤±è´¥: ${e.message}"
    }
}
def isZipValid = { zipFile ->
    try {
        new ZipFile(zipFile).close()
        return true
    } catch (IOException ignored) {
        return false
    }
}
def uninstall = {
    if (preCommitFile.exists()) {
        preCommitFile.delete()
    }
    if (resCheckerFile.exists()) {
        resCheckerFile.delete()
    }
}
def install = { Boolean force = false ->
    if (force) {
        uninstall()
    }

    if (preCommitFile.exists() && resCheckerFile.exists()) {
        logInfo "å·²å®‰è£…CodeQualityTools, å¼ºåˆ¶æ›´æ–°è¯·æ‰§è¡Œ: ./gradlew forceReinstallCQT"
        return
    }

    File tempZip = File.createTempFile("tools", ".zip")

    download(toolsZipUrl, tempZip)

    if (!tempZip.exists()) {
        logError "âä¸‹è½½ç›®æ ‡æ–‡ä»¶ä¸æˆåŠŸ"
        return
    }
    if (!isZipValid(tempZip)) {
        logError "zipæ–‡ä»¶æŸå"
        return
    }

    logInfo "ğŸ”›å¼€å§‹è§£å‹åˆ°ç›®æ ‡è·¯å¾„..."
    project.copy {
        from zipTree(tempZip)
        into(gitRoot)

        filesMatching("**/hooks/pre-commit") {
            filter { line ->
                return line.replace('${PROJECT_NAME}', "PROJECT_NAME=\"${project.name}\"")
                        .replace('${JAVA_HOME}', "JAVA_HOME=\"${System.getProperty("java.home")}\"")
            }
        }
    }
    logSuccess "âœ…è§£å‹æˆåŠŸ"

    if (preCommitFile.exists()) {
        preCommitFile.setExecutable(true, false)
    }
    if (resCheckerFile.exists()) {
        resCheckerFile.setExecutable(true, false)
    }
}

task forceReinstallCQT() {
    doLast {
        install(true)
    }
}

task uninstallCQT() {
    doLast {
        logInfo "å¸è½½ä¸­..."
        uninstall()
        logSuccess "âœ…å¸è½½æˆåŠŸ"
    }
}

afterEvaluate {
    install()
}